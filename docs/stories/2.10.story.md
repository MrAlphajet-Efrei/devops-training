# Story 2.10: GitHub Environments & Production Approval

## Status

**Draft**

---

## Story

**As a** DevOps engineer,
**I want** GitHub Environments configured with protection rules,
**so that** production deployments require explicit approval.

---

## Prerequisites

> **⚠️ IMPORTANT:** GitHub Environments with protection rules require:
> - A **public repository**, OR
> - **GitHub Pro, Team, or Enterprise** plan for private repositories
>
> Verify this before starting. If using a private repo on free tier, environments will be created but protection rules (required reviewers) won't be available.

---

## Acceptance Criteria

1. GitHub Environment `dev` is created (no protection rules)
2. GitHub Environment `prod` is created with required reviewers
3. Deployment workflow references environments
4. Dev deployment runs automatically after build
5. Prod deployment waits for manual approval
6. Environment secrets are scoped appropriately
7. Deployment history is visible in GitHub Environments UI
8. Documentation explains the approval workflow

---

## Tasks / Subtasks

- [ ] **Task 1: Create GitHub Environments** (AC: 1, 2)
  - [ ] In GitHub repo Settings → Environments:
  - [ ] Create `dev` environment:
    - No protection rules
    - No required reviewers
    - No wait timer
  - [ ] Create `prod` environment:
    - Add required reviewers (add yourself)
    - Optionally add wait timer (e.g., 5 minutes)
    - Enable "Prevent self-review" if desired (optional for solo project)

- [ ] **Task 2: Configure Environment-Scoped Secrets** (AC: 6)
  - [ ] Move relevant secrets to environment scope OR keep at repository level:
    - **Repository-level secrets** (shared across all environments):
      - `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`, `AZURE_TENANT_ID`, `AZURE_SUBSCRIPTION_ID`
      - `ACR_LOGIN_SERVER`, `ACR_USERNAME`, `ACR_PASSWORD`
    - **Environment-specific secrets** (if different per env):
      - `dev`: Could add `KUBECONFIG_DEV` for dev cluster access
      - `prod`: Could add `KUBECONFIG_PROD` for prod cluster access
  - [ ] For this learning project, repository-level secrets are sufficient
  - [ ] Document the secrets scope strategy

- [ ] **Task 3: Update CD Workflow to Use Environments** (AC: 3, 4, 5)
  - [ ] Update `.github/workflows/cd.yaml`:
  - [ ] Modify `deploy-dev` job to reference environment:
    ```yaml
    deploy-dev:
      needs: [build-and-push]
      runs-on: ubuntu-latest
      environment: dev
      steps:
        # ... existing deploy steps from Story 2.8
    ```
  - [ ] Add `deploy-prod` job with environment and manual gate:
    ```yaml
    deploy-prod:
      needs: [deploy-dev]
      runs-on: ubuntu-latest
      environment: prod
      steps:
        # Similar to deploy-dev but with prod values
        # Uses values-prod.yaml
        # Different image pull policy (Always instead of Never)
    ```
  - [ ] Prod job uses `helmfile -e prod sync` with `values-prod.yaml`
  - [ ] Prod deploy requires the `prod` environment approval

- [ ] **Task 4: Implement Prod Deployment** (AC: 5)
  - [ ] Prod deployment job steps:
    1. Checkout code
    2. Configure kubectl (for prod cluster — for now, same Kind approach as dev)
    3. Install Helm + Helmfile
    4. Create prod namespace and imagePullSecrets:
       ```bash
       kubectl create namespace devops-demo-prod --dry-run=client -o yaml | kubectl apply -f -
       kubectl create secret docker-registry acr-secret \
         --docker-server=${{ secrets.ACR_LOGIN_SERVER }} \
         --docker-username=${{ secrets.ACR_USERNAME }} \
         --docker-password=${{ secrets.ACR_PASSWORD }} \
         -n devops-demo-prod
       ```
    5. Deploy with prod values: `helmfile -e prod sync --set api.image.tag=$IMAGE_TAG --set frontend.image.tag=$IMAGE_TAG`
    6. Wait for rollout
    7. Smoke test
    8. Write summary
  - [ ] Note: In a real scenario, prod would target a different cluster (AKS). For this project, both dev and prod can use the same Kind cluster with different Helmfile environments and namespaces.

- [ ] **Task 5: Add Deployment Summary with URLs** (AC: 7, 8)
  - [ ] Update deployment summary step in both dev and prod jobs:
    ```yaml
    # For deploy-dev job:
    - name: Deployment Summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: dev" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace**: devops-demo" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check**: Passed ✅" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Verify Deployment" >> $GITHUB_STEP_SUMMARY
        echo "View deployment history: Settings → Environments" >> $GITHUB_STEP_SUMMARY

    # For deploy-prod job:
    - name: Deployment Summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: prod" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace**: devops-demo-prod" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check**: Passed ✅" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Verify Deployment" >> $GITHUB_STEP_SUMMARY
        echo "View deployment history: Settings → Environments" >> $GITHUB_STEP_SUMMARY
    ```
  - [ ] After running the pipeline, verify in GitHub Environments UI:
    - Navigate to repo → Settings → Environments
    - Verify both `dev` and `prod` show deployment history
  - [ ] Each deployment should show: commit SHA, status, timestamp

- [ ] **Task 6: Document Approval Workflow** (AC: 8)
  - [ ] Update `docs/setup-guide.md` with new section "## Deployment Approval Workflow":
    - Environment setup (dev vs prod)
    - Protection rules on prod
    - How the approval workflow works:
      1. Developer pushes to main
      2. CI runs (lint, test)
      3. CD builds and pushes images
      4. Dev deployment runs automatically
      5. Prod deployment waits for reviewer approval
      6. Reviewer approves/rejects in GitHub UI
      7. Prod deployment proceeds if approved
    - How to approve/reject deployments (with screenshots or step-by-step)
    - How to view deployment history
    - Prerequisites note about GitHub plan requirements

- [ ] **Task 7: Test Full Pipeline with Approval** (AC: 1-8)
  - [ ] Push a change to main
  - [ ] Verify dev deploys automatically
  - [ ] Verify prod job shows "Waiting for review" in GitHub Actions UI
  - [ ] Approve the prod deployment
  - [ ] Verify prod deployment runs after approval
  - [ ] Verify deployment history shows in Environments UI
  - [ ] Test rejection: push another change, reject the prod deployment
  - [ ] Verify pipeline stops cleanly on rejection

---

## Dev Notes

### GitHub Environments Feature

GitHub Environments provide:
- **Deployment targets**: Named environments (dev, staging, prod)
- **Protection rules**: Required reviewers, wait timers, branch restrictions
- **Environment secrets**: Secrets scoped to specific environments
- **Deployment history**: Track what was deployed where and when

### CI/CD Pipeline — Complete Flow

[Source: architecture/14-deployment-architecture.md#14.3]

```
Push to main
    │
    ├── CI (lint, test, build validation) ─── Story 2.6
    │
    ├── CD Build (Docker build, push to ACR) ─── Story 2.7
    │
    ├── Deploy Dev (automatic) ─── Story 2.8 + THIS STORY
    │     └── environment: dev
    │
    └── Deploy Prod (manual approval) ─── THIS STORY
          └── environment: prod
          └── Required reviewers: ✋ WAIT
```

This matches the architecture spec: "Production: Manual approval required"

### Environment-Specific Helm Values

From Story 1.9:

**Dev** (`values-dev.yaml`):
- 1 replica, `imagePullPolicy: Never`, debug=true, lower resources

**Prod** (`values-prod.yaml`):
- 2 replicas, `imagePullPolicy: Always`, debug=false, higher resources

### Workflow Environment Reference

```yaml
jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: dev          # <-- Links to GitHub Environment
    # ...

  deploy-prod:
    needs: [deploy-dev]
    runs-on: ubuntu-latest
    environment: prod         # <-- Links to GitHub Environment (triggers approval gate)
    # ...
```

When a job references `environment: prod`, and the `prod` environment has required reviewers, GitHub Actions automatically pauses the job and waits for approval.

### Key Constraints

- **⚠️ GitHub Environments require a public repo** OR GitHub Pro/Team/Enterprise for private repos — **VERIFY BEFORE STARTING**
- **Self-review**: For a solo project, you can still approve your own deployments (unless "Prevent self-review" is enabled)
- **Same cluster for dev/prod**: In this learning project, both environments deploy to the same Kind cluster but with different Helmfile environments and namespaces (`devops-demo` for dev, `devops-demo-prod` for prod). In production, they'd target different clusters.
- **Prod image pull**: For prod, `imagePullPolicy: Always` means K8s needs to pull from ACR. This requires imagePullSecrets in the prod namespace — **handled in Task 4**.
- **Branch restrictions**: Optionally restrict prod environment to only deploy from `main` branch (recommended)
- **Helmfile prod environment**: Story 1.9 must define `prod` environment in `helmfile.yaml` with `values-prod.yaml`

### Dependencies on Previous Stories

- **Story 2.7**: Build & push job (provides images and `image-tag` output)
- **Story 2.8**: Dev deployment job (this story enhances it with environment)
- **Story 1.9**: Helm charts with dev and prod values — **MUST have `prod` environment in helmfile.yaml**:
  ```yaml
  # infra/helm/helmfile.yaml must include:
  environments:
    dev:
      values:
        - environments/values-dev.yaml
    prod:
      values:
        - environments/values-prod.yaml
  ```

---

## Testing

### Testing Requirements

| Test Type | Coverage | Method |
|-----------|----------|--------|
| E2E | Dev auto-deploy | Push to main |
| E2E | Prod manual approval | Approve in GitHub UI |
| E2E | Deployment history | GitHub Environments UI |

[Source: architecture/16-testing-strategy.md — E2E: curl smoke tests]

### Test Scenarios

1. **Dev environment exists** — GitHub Settings → Environments shows `dev`
2. **Prod environment exists** — GitHub Settings → Environments shows `prod` with reviewers
3. **Dev deploys automatically** — Push to main → dev deploy runs without pause
4. **Prod waits for approval** — Deploy prod job shows "Waiting for review"
5. **Approval proceeds** — Approving allows prod deploy to run
6. **Rejection stops** — Rejecting stops the pipeline cleanly
7. **Deployment history visible** — Both environments show deployment records
8. **Secrets accessible** — Jobs can access repository-level secrets

### Test Commands

```bash
# Push a change
git push origin main

# Monitor workflows
gh run list --workflow=cd.yaml
gh run watch <run-id>

# View environments (via GitHub UI)
# Repo → Settings → Environments

# Approve deployment (via GitHub UI)
# Actions → Workflow Run → Review deployments → Approve

# Or via CLI (if available)
gh run view <run-id>
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Initial story draft | SM Bob |
| 2026-01-28 | 1.1 | Fixed: Added GitHub plan prerequisite, added prod imagePullSecrets task, specified docs location, added deployment summary URLs, clarified helmfile prod dependency | PO Sarah |
| 2026-01-28 | 1.2 | Fixed: Separated dev/prod deployment summaries with correct namespaces (devops-demo vs devops-demo-prod) | SM Bob |

---

## Dev Agent Record

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
