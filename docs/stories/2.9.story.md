# Story 2.9: GitHub Actions - Terraform in Pipeline

## Status

**Draft**

---

## Story

**As a** DevOps engineer,
**I want** Terraform plan/apply integrated into the CI/CD pipeline,
**so that** infrastructure changes follow the same review process as code.

---

## Acceptance Criteria

1. Terraform workflow exists at `.github/workflows/terraform.yaml`
2. Workflow triggers on changes to `infra/terraform/**`
3. `terraform fmt -check` validates formatting
4. `terraform validate` checks configuration
5. `terraform plan` runs on pull requests (output as PR comment)
6. `terraform apply` runs on merge to main (with auto-approve or manual)
7. Azure credentials are passed via environment variables
8. State locking prevents concurrent modifications
9. Workflow uses specific Terraform version (pinned)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Terraform Workflow File** (AC: 1, 2, 9)
  - [ ] Create `.github/workflows/terraform.yaml`
  - [ ] Configure triggers:
    ```yaml
    on:
      push:
        branches: [main]
        paths: ['infra/terraform/**']
      pull_request:
        branches: [main]
        paths: ['infra/terraform/**']
    ```
  - [ ] Pin Terraform version (e.g., `1.5.7` or latest stable 1.5+)
  - [ ] Add concurrency control

- [ ] **Task 2: Configure Azure Credentials** (AC: 7)
  - [ ] Reference GitHub Secrets (already configured in Story 2.7):
    ```yaml
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    ```
  - [ ] Set as job-level environment variables

- [ ] **Task 3: Add Format and Validate Steps** (AC: 3, 4)
  - [ ] Define `terraform` job on `ubuntu-latest`
  - [ ] Steps:
    1. Checkout code: `actions/checkout@v4`
    2. Setup Terraform: `hashicorp/setup-terraform@v3` with pinned version
    3. Terraform init: `terraform init` (in `infra/terraform/` directory)
    4. Terraform format check: `terraform fmt -check -recursive`
    5. Terraform validate: `terraform validate`
  - [ ] Use `working-directory: infra/terraform` for all terraform commands

- [ ] **Task 4: Add Terraform Plan on PRs** (AC: 5, 8)
  - [ ] Add plan step (runs on all triggers):
    ```bash
    terraform plan -no-color -out=tfplan
    ```
  - [ ] Add step to post plan output as PR comment (only on PR):
    ```yaml
    - uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const output = `#### Terraform Plan ðŸ“–
          <details><summary>Show Plan</summary>

          \`\`\`
          ${process.env.PLAN}
          \`\`\`

          </details>`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
    ```
  - [ ] Capture plan output in an environment variable for the comment
  - [ ] State locking is automatic with azurerm backend (AC8)

- [ ] **Task 5: Add Terraform Apply on Main** (AC: 6)
  - [ ] Add apply step that only runs on push to main:
    ```yaml
    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: terraform apply -auto-approve tfplan
    ```
  - [ ] Use the saved plan file from the plan step for consistency
  - [ ] Note: `-auto-approve` is used because the plan was already reviewed in PR

- [ ] **Task 6: Add Job Summary** (AC: 5, 6)
  - [ ] Write plan/apply results to `$GITHUB_STEP_SUMMARY`
  - [ ] Include: resources to add/change/destroy count
  - [ ] Include: apply status (success/failure) on main

- [ ] **Task 7: Test Workflow** (AC: 1-9)
  - [ ] Create a branch with a Terraform change (e.g., add a tag to ACR)
  - [ ] Open PR â€” verify plan runs and posts comment
  - [ ] Verify format check and validate pass
  - [ ] Merge PR â€” verify apply runs on main
  - [ ] Verify state locking works (check for lease in Azure)
  - [ ] Verify Terraform version matches pinned version

---

## Dev Notes

### Workflow File Location

[Source: architecture/12-unified-project-structure.md]

```
.github/workflows/
â”œâ”€â”€ ci.yaml        # Story 2.6
â”œâ”€â”€ cd.yaml        # Stories 2.7, 2.8
â””â”€â”€ terraform.yaml # THIS STORY
```

### CI/CD Pipeline â€” Terraform Flow

[Source: architecture/14-deployment-architecture.md#14.3]

The Terraform workflow is separate from the app CI/CD pipeline:
- **On PR**: fmt â†’ validate â†’ plan â†’ post as PR comment
- **On merge to main**: fmt â†’ validate â†’ plan â†’ apply (auto-approve)

### Terraform Version

[Source: architecture/3-tech-stack.md]
- Terraform 1.5+ â€” pin to a specific version for reproducibility (e.g., `1.5.7`)

### Setup Terraform Action

```yaml
- uses: hashicorp/setup-terraform@v3
  with:
    terraform_version: "1.5.7"
    terraform_wrapper: true  # Enables output capture
```

The `terraform_wrapper: true` setting allows capturing plan output for PR comments.

### State Locking

[Source: Story 2.2 â€” azurerm backend]

State locking is automatic with the azurerm backend. Azure Blob lease mechanism prevents concurrent `terraform apply` runs. The workflow concurrency group also prevents parallel workflow runs:

```yaml
concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel in-progress terraform runs!
```

**CRITICAL**: Do NOT set `cancel-in-progress: true` for Terraform workflows â€” cancelling a running apply can leave state in a corrupted state.

### PR Comment Pattern

The plan output is posted as a collapsible PR comment so reviewers can see exactly what infrastructure changes will be made. This implements "infrastructure changes follow the same review process as code."

### Environment Variables for Azure

These secrets were already configured in Story 2.7:
- `AZURE_CLIENT_ID`
- `AZURE_CLIENT_SECRET`
- `AZURE_SUBSCRIPTION_ID`
- `AZURE_TENANT_ID`

Terraform expects them as `ARM_*` prefixed variables.

### Key Constraints

- **Path filter** â€” workflow only runs when `infra/terraform/**` files change
- **Do NOT cancel in-progress** â€” Terraform apply should never be interrupted
- **Plan file** â€” saving plan output ensures apply matches what was reviewed
- **`terraform_wrapper: true`** â€” needed to capture output as environment variables
- **PR comment** â€” uses `actions/github-script@v7` to interact with GitHub API
- **Auto-approve on main** â€” acceptable because the plan was reviewed in PR
- **Sensitive output** â€” plan might contain sensitive values; collapsible details section helps

### Dependencies on Previous Stories

- **Story 2.2**: Terraform backend configured with remote state
- **Story 2.5**: Terraform modules structured and validated
- **Story 2.7**: GitHub Secrets for Azure credentials already configured

---

## Testing

### Testing Requirements

| Test Type | Coverage | Method |
|-----------|----------|--------|
| E2E | Workflow triggers on TF changes | PR with infra change |
| E2E | Plan as PR comment | Open PR, check comment |
| E2E | Apply on merge | Merge PR, check Azure |

[Source: architecture/16-testing-strategy.md â€” E2E: curl smoke tests]

### Test Scenarios

1. **Workflow triggers on TF change** â€” PR modifying `infra/terraform/` triggers workflow
2. **Does NOT trigger on app changes** â€” PR modifying only `apps/` does NOT trigger
3. **Format check passes** â€” `terraform fmt -check` exits 0
4. **Validate passes** â€” `terraform validate` exits 0
5. **Plan output posted to PR** â€” PR has a comment with plan details
6. **Apply runs on merge** â€” Merging PR applies changes
7. **Terraform version pinned** â€” Correct version in logs
8. **State locking works** â€” No concurrent modifications
9. **Concurrency prevents parallel runs** â€” Only one TF workflow runs at a time

### Test Commands

```bash
# Create test branch with TF change
git checkout -b test/terraform-change
# Make a small change (e.g., add a tag to ACR resource)
# Push and create PR

# Verify workflow triggers
gh pr create --title "Test TF pipeline" --body "Testing terraform workflow"
gh run list --workflow=terraform.yaml

# Verify PR comment
gh pr view <pr-number> --comments

# Merge and verify apply
gh pr merge <pr-number>
gh run list --workflow=terraform.yaml

# Verify Azure resource updated
az acr show --name <acr-name> -o table
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Initial story draft | SM Bob |

---

## Dev Agent Record

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
