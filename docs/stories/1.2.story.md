# Story 1.2: Python API Service with Health Endpoint

## Status

**Draft**

---

## Story

**As a** DevOps engineer,
**I want** a Python FastAPI service with a health check endpoint,
**so that** I have a backend service ready for containerization and Kubernetes probes.

---

## Acceptance Criteria

1. FastAPI application is created in `apps/api/`
2. `/health` endpoint returns `{"status": "healthy"}` with 200 OK
3. `/ready` endpoint checks database connectivity (returns 503 if unavailable)
4. Basic project structure with `requirements.txt` or `pyproject.toml`
5. Application runs locally with `uvicorn` on port 8000
6. Unit tests exist for health endpoints using pytest
7. `README.md` documents how to run the API locally

---

## Tasks / Subtasks

- [ ] **Task 1: Initialize Python Project Structure** (AC: 1, 4)
  - [ ] Create `apps/api/` directory structure following backend architecture
  - [ ] Create `apps/api/pyproject.toml` with project metadata and dependencies
  - [ ] Create `apps/api/src/app/` directory for application code
  - [ ] Create `apps/api/tests/` directory for test files
  - [ ] Add `.python-version` file (3.11)
  - [ ] Create `apps/api/.gitignore` for Python-specific ignores

- [ ] **Task 2: Configure Dependencies** (AC: 4)
  - [ ] Add FastAPI dependency (`fastapi>=0.109.0`)
  - [ ] Add Uvicorn dependency (`uvicorn[standard]>=0.27.0`)
  - [ ] Add Pydantic Settings (`pydantic-settings>=2.0.0`)
  - [ ] Add pytest and httpx for testing (`pytest>=7.0.0`, `httpx>=0.26.0`)
  - [ ] Add pytest-asyncio for async test support
  - [ ] Configure Poetry or pip for dependency management

- [ ] **Task 3: Create Configuration Module** (AC: 1)
  - [ ] Create `src/app/config.py` with Pydantic Settings
  - [ ] Define `Settings` class with database configuration placeholders
  - [ ] Add `debug` and `cors_origins` settings
  - [ ] Load settings from environment variables

- [ ] **Task 4: Create FastAPI Application** (AC: 1, 5)
  - [ ] Create `src/app/main.py` with application factory pattern
  - [ ] Initialize FastAPI app with title and version
  - [ ] Configure CORS middleware (allow localhost:3000)
  - [ ] Create main router in `src/app/api/router.py`
  - [ ] Include health routes in main router

- [ ] **Task 5: Implement Health Endpoints** (AC: 2, 3)
  - [ ] Create `src/app/api/routes/health.py`
  - [ ] Implement `GET /health` returning `{"status": "healthy", "timestamp": "..."}`
  - [ ] Implement `GET /ready` that checks database connectivity
  - [ ] Return 200 if database reachable, 503 if not
  - [ ] Create Pydantic schema for HealthResponse

- [ ] **Task 6: Write Unit Tests** (AC: 6)
  - [ ] Create `tests/conftest.py` with test client fixture
  - [ ] Create `tests/test_health.py`
  - [ ] Test `/health` returns 200 and correct JSON structure
  - [ ] Test `/ready` returns 503 when database unavailable
  - [ ] Test `/ready` returns 200 when database available (mock)

- [ ] **Task 7: Create API README** (AC: 7)
  - [ ] Document project overview and purpose
  - [ ] Document prerequisites (Python 3.11+, Poetry/pip)
  - [ ] Document installation steps
  - [ ] Document how to run locally (`uvicorn app.main:app --reload`)
  - [ ] Document how to run tests (`pytest -v`)
  - [ ] Document available endpoints
  - [ ] Document environment variables

---

## Dev Notes

### Relevant Source Tree

```
apps/api/
├── src/
│   └── app/
│       ├── __init__.py
│       ├── main.py                 # FastAPI application entry
│       ├── config.py               # Settings (Pydantic)
│       ├── api/
│       │   ├── __init__.py
│       │   ├── router.py           # Main router
│       │   ├── deps.py             # Dependencies (DB session)
│       │   └── routes/
│       │       ├── __init__.py
│       │       └── health.py       # Health endpoints
│       └── models/                 # Pydantic schemas
│           ├── __init__.py
│           └── health.py
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   └── test_health.py
├── pyproject.toml
├── README.md
└── .gitignore
```

### API Specification Reference

| Method | Path | Purpose | Response |
|--------|------|---------|----------|
| `GET` | `/health` | Liveness probe | `{"status": "healthy", "timestamp": "..."}` |
| `GET` | `/ready` | Readiness probe | 200 OK or 503 Service Unavailable |

### Health Response Schema

```python
class HealthResponse(BaseModel):
    status: Literal["healthy", "unhealthy"]
    timestamp: datetime
```

### Configuration Pattern

```python
# src/app/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    db_host: str = "localhost"
    db_port: int = 5432
    db_name: str = "devops_demo"
    db_user: str = "app_user"
    db_password: str = ""  # Empty for this story, will be set in Story 1.3
    debug: bool = False
    cors_origins: list[str] = ["http://localhost:3000"]

    class Config:
        env_file = ".env"

settings = Settings()
```

### Application Factory Pattern

```python
# src/app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.config import settings
from app.api.router import api_router

def create_app() -> FastAPI:
    app = FastAPI(title="DevOps Learning API", version="1.0.0")

    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.cors_origins,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

    app.include_router(api_router)

    return app

app = create_app()
```

### Tech Stack for This Story

| Technology | Version | Purpose |
|------------|---------|---------|
| Python | 3.11+ | Runtime |
| FastAPI | 0.109+ | Web framework |
| Uvicorn | 0.27+ | ASGI server |
| Pydantic | 2.x | Data validation |
| pytest | 7.x | Testing framework |
| httpx | 0.26+ | Async HTTP client for tests |

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `DB_HOST` | localhost | Database hostname |
| `DB_PORT` | 5432 | Database port |
| `DB_NAME` | devops_demo | Database name |
| `DB_USER` | app_user | Database username |
| `DB_PASSWORD` | - | Database password |
| `DEBUG` | false | Enable debug mode |

### Key Constraints

- **Type Safety**: Use Pydantic for all API I/O (coding standards)
- **Secrets**: Database password via environment variable, never hardcode
- **Logging**: Prepare for structured JSON logging (to be added in later story)
- **Port**: Application runs on port 8000

### Dependencies on Previous Stories

- **Story 1.1**: Project structure must exist (`apps/api/` directory)

### Important Implementation Notes

1. The `/ready` endpoint should gracefully handle missing database connection
2. For this story, database connection can return 503 (database not yet set up)
3. Use async patterns for FastAPI routes
4. Follow PEP 8 and use type hints throughout
5. The application factory pattern enables easier testing

---

## Testing

### Testing Requirements

| Test Type | Coverage Target | Framework |
|-----------|-----------------|-----------|
| Unit Tests | Health endpoints | pytest + httpx |
| Coverage | 70%+ | pytest-cov |

### Test Scenarios

1. **test_health_endpoint_returns_200**
   - Call `GET /health`
   - Assert status code 200
   - Assert response contains `status` and `timestamp`
   - Assert `status` equals "healthy"

2. **test_ready_endpoint_returns_503_when_db_unavailable**
   - Call `GET /ready` (with no database)
   - Assert status code 503

3. **test_ready_endpoint_returns_200_when_db_available**
   - Mock database connection
   - Call `GET /ready`
   - Assert status code 200

### Test Commands

```bash
# Navigate to API directory
cd apps/api

# Install dependencies
poetry install  # or pip install -e ".[dev]"

# Run tests
pytest -v

# Run tests with coverage
pytest -v --cov=app --cov-report=term-missing
```

### Test Fixtures Example

```python
# tests/conftest.py
import pytest
from fastapi.testclient import TestClient
from app.main import create_app

@pytest.fixture
def client():
    app = create_app()
    with TestClient(app) as client:
        yield client
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-26 | 1.0 | Initial story draft | SM Bob |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
