# Story 1.2: Python API Service with Health Endpoint

## Status

**Done**

---

## Story

**As a** DevOps engineer,
**I want** a Python FastAPI service with a health check endpoint,
**so that** I have a backend service ready for containerization and Kubernetes probes.

---

## Acceptance Criteria

1. FastAPI application is created in `apps/api/`
2. `/health` endpoint returns `{"status": "healthy"}` with 200 OK
3. `/ready` endpoint checks database connectivity (returns 503 if unavailable)
4. Basic project structure with `requirements.txt` or `pyproject.toml`
5. Application runs locally with `uvicorn` on port 8000
6. Unit tests exist for health endpoints using pytest
7. `README.md` documents how to run the API locally

---

## Tasks / Subtasks

- [x] **Task 1: Initialize Python Project Structure** (AC: 1, 4)
  - [x] Create `apps/api/` directory structure following backend architecture
  - [x] Create `apps/api/pyproject.toml` with project metadata and dependencies
  - [x] Create `apps/api/src/app/` directory for application code
  - [x] Create `apps/api/tests/` directory for test files
  - [x] Add `.python-version` file (3.11)
  - [x] Create `apps/api/.gitignore` for Python-specific ignores

- [x] **Task 2: Configure Dependencies** (AC: 4)
  - [x] Add FastAPI dependency (`fastapi>=0.109.0`)
  - [x] Add Uvicorn dependency (`uvicorn[standard]>=0.27.0`)
  - [x] Add Pydantic Settings (`pydantic-settings>=2.0.0`)
  - [x] Add pytest and httpx for testing (`pytest>=7.0.0`, `httpx>=0.26.0`)
  - [x] Add pytest-asyncio for async test support
  - [x] Configure Poetry or pip for dependency management

- [x] **Task 3: Create Configuration Module** (AC: 1)
  - [x] Create `src/app/config.py` with Pydantic Settings
  - [x] Define `Settings` class with database configuration placeholders
  - [x] Add `debug` and `cors_origins` settings
  - [x] Load settings from environment variables

- [x] **Task 4: Create FastAPI Application** (AC: 1, 5)
  - [x] Create `src/app/main.py` with application factory pattern
  - [x] Initialize FastAPI app with title and version
  - [x] Configure CORS middleware (allow localhost:3000)
  - [x] Create main router in `src/app/api/router.py`
  - [x] Include health routes in main router

- [x] **Task 5: Implement Health Endpoints** (AC: 2, 3)
  - [x] Create `src/app/api/routes/health.py`
  - [x] Implement `GET /health` returning `{"status": "healthy", "timestamp": "..."}`
  - [x] Implement `GET /ready` that checks database connectivity
  - [x] Return 200 if database reachable, 503 if not
  - [x] Create Pydantic schema for HealthResponse

- [x] **Task 6: Write Unit Tests** (AC: 6)
  - [x] Create `tests/conftest.py` with test client fixture
  - [x] Create `tests/test_health.py`
  - [x] Test `/health` returns 200 and correct JSON structure
  - [x] Test `/ready` returns 503 when database unavailable
  - [x] Test `/ready` returns 200 when database available (mock)

- [x] **Task 7: Create API README** (AC: 7)
  - [x] Document project overview and purpose
  - [x] Document prerequisites (Python 3.11+, Poetry/pip)
  - [x] Document installation steps
  - [x] Document how to run locally (`uvicorn app.main:app --reload`)
  - [x] Document how to run tests (`pytest -v`)
  - [x] Document available endpoints
  - [x] Document environment variables

---

## Dev Notes

### Relevant Source Tree

```
apps/api/
├── src/
│   └── app/
│       ├── __init__.py
│       ├── main.py                 # FastAPI application entry
│       ├── config.py               # Settings (Pydantic)
│       ├── api/
│       │   ├── __init__.py
│       │   ├── router.py           # Main router
│       │   ├── deps.py             # Dependencies (DB session)
│       │   └── routes/
│       │       ├── __init__.py
│       │       └── health.py       # Health endpoints
│       └── models/                 # Pydantic schemas
│           ├── __init__.py
│           └── health.py
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   └── test_health.py
├── pyproject.toml
├── README.md
└── .gitignore
```

### API Specification Reference

| Method | Path      | Purpose         | Response                                    |
| ------ | --------- | --------------- | ------------------------------------------- |
| `GET`  | `/health` | Liveness probe  | `{"status": "healthy", "timestamp": "..."}` |
| `GET`  | `/ready`  | Readiness probe | 200 OK or 503 Service Unavailable           |

### Health Response Schema

```python
class HealthResponse(BaseModel):
    status: Literal["healthy", "unhealthy"]
    timestamp: datetime
```

### Configuration Pattern

```python
# src/app/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    db_host: str = "localhost"
    db_port: int = 5432
    db_name: str = "devops_demo"
    db_user: str = "app_user"
    db_password: str = ""  # Empty for this story, will be set in Story 1.3
    debug: bool = False
    cors_origins: list[str] = ["http://localhost:3000"]

    class Config:
        env_file = ".env"

settings = Settings()
```

### Application Factory Pattern

```python
# src/app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.config import settings
from app.api.router import api_router

def create_app() -> FastAPI:
    app = FastAPI(title="DevOps Learning API", version="1.0.0")

    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.cors_origins,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

    app.include_router(api_router)

    return app

app = create_app()
```

### Tech Stack for This Story

| Technology | Version | Purpose                     |
| ---------- | ------- | --------------------------- |
| Python     | 3.11+   | Runtime                     |
| FastAPI    | 0.109+  | Web framework               |
| Uvicorn    | 0.27+   | ASGI server                 |
| Pydantic   | 2.x     | Data validation             |
| pytest     | 7.x     | Testing framework           |
| httpx      | 0.26+   | Async HTTP client for tests |

### Environment Variables

| Variable      | Default     | Description       |
| ------------- | ----------- | ----------------- |
| `DB_HOST`     | localhost   | Database hostname |
| `DB_PORT`     | 5432        | Database port     |
| `DB_NAME`     | devops_demo | Database name     |
| `DB_USER`     | app_user    | Database username |
| `DB_PASSWORD` | -           | Database password |
| `DEBUG`       | false       | Enable debug mode |

### Key Constraints

- **Type Safety**: Use Pydantic for all API I/O (coding standards)
- **Secrets**: Database password via environment variable, never hardcode
- **Logging**: Prepare for structured JSON logging (to be added in later story)
- **Port**: Application runs on port 8000

### Dependencies on Previous Stories

- **Story 1.1**: Project structure must exist (`apps/api/` directory)

### Important Implementation Notes

1. The `/ready` endpoint should gracefully handle missing database connection
2. For this story, database connection can return 503 (database not yet set up)
3. Use async patterns for FastAPI routes
4. Follow PEP 8 and use type hints throughout
5. The application factory pattern enables easier testing

---

## Testing

### Testing Requirements

| Test Type  | Coverage Target  | Framework      |
| ---------- | ---------------- | -------------- |
| Unit Tests | Health endpoints | pytest + httpx |
| Coverage   | 70%+             | pytest-cov     |

### Test Scenarios

1. **test_health_endpoint_returns_200**
   - Call `GET /health`
   - Assert status code 200
   - Assert response contains `status` and `timestamp`
   - Assert `status` equals "healthy"

2. **test_ready_endpoint_returns_503_when_db_unavailable**
   - Call `GET /ready` (with no database)
   - Assert status code 503

3. **test_ready_endpoint_returns_200_when_db_available**
   - Mock database connection
   - Call `GET /ready`
   - Assert status code 200

### Test Commands

```bash
# Navigate to API directory
cd apps/api

# Install dependencies
poetry install  # or pip install -e ".[dev]"

# Run tests
pytest -v

# Run tests with coverage
pytest -v --cov=app --cov-report=term-missing
```

### Test Fixtures Example

```python
# tests/conftest.py
import pytest
from fastapi.testclient import TestClient
from app.main import create_app

@pytest.fixture
def client():
    app = create_app()
    with TestClient(app) as client:
        yield client
```

---

## Change Log

| Date       | Version | Description         | Author |
| ---------- | ------- | ------------------- | ------ |
| 2025-01-26 | 1.0     | Initial story draft | SM Bob |
| 2026-01-27 | 1.1     | Implementation complete - all tasks done, 3/3 tests pass, 89% coverage | Dev James |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Fixed `pyproject.toml` build-backend from `setuptools.backends._legacy:_Backend` to `setuptools.build_meta` (module not found error with uv)

### Completion Notes List

- All 7 tasks implemented and verified
- 3/3 tests passing
- 89% code coverage (above 70% target)
- Used `uv` for dependency management per user preference
- Used `model_config` dict instead of inner `Config` class (Pydantic v2 style)
- `/ready` uses socket connection check for DB connectivity (graceful failure when no DB)

### File List

- `apps/api/pyproject.toml` — Project metadata and dependencies
- `apps/api/.python-version` — Python version pin (3.11)
- `apps/api/.gitignore` — Python-specific ignores
- `apps/api/README.md` — API documentation
- `apps/api/src/app/__init__.py` — App package init
- `apps/api/src/app/main.py` — FastAPI application factory
- `apps/api/src/app/config.py` — Pydantic Settings configuration
- `apps/api/src/app/api/__init__.py` — API package init
- `apps/api/src/app/api/router.py` — Main API router
- `apps/api/src/app/api/routes/__init__.py` — Routes package init
- `apps/api/src/app/api/routes/health.py` — Health & readiness endpoints
- `apps/api/src/app/models/__init__.py` — Models package init
- `apps/api/src/app/models/health.py` — HealthResponse Pydantic schema
- `apps/api/tests/__init__.py` — Tests package init
- `apps/api/tests/conftest.py` — Test fixtures (TestClient)
- `apps/api/tests/test_health.py` — Health endpoint unit tests

---

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Solid implementation of a FastAPI service with health endpoints. Code is clean, well-structured, and follows the application factory pattern as specified.

**Strengths:**
- Application factory pattern (`create_app()`) enables clean testing
- Pydantic v2 `model_config` dict used correctly (modern approach)
- `HealthResponse` schema with `Literal["healthy", "unhealthy"]` provides type safety
- Socket-based DB connectivity check is lightweight and appropriate for a readiness probe
- Tests use proper mocking of `_check_db_connectivity` to isolate behavior
- 89% code coverage exceeds the 70% target
- `pyproject.toml` properly separates runtime and dev dependencies

**Findings (CONCERNS - non-blocking):**

1. **CORS `allow_methods=["*"]` and `allow_headers=["*"]`** (`main.py:15-16`): Overly permissive for production. Acceptable for a learning project but should be tightened before any real deployment. Only `GET` is needed for health endpoints.

2. **Blocking socket call in async route** (`health.py:26-34`): `_check_db_connectivity()` uses synchronous `socket.create_connection()` inside an `async def` route. This blocks the event loop for up to 2 seconds on timeout. For a readiness probe this is tolerable, but in production you'd want `asyncio.open_connection()` or `run_in_executor()`. Acceptable for this story scope.

3. **Missing `deps.py`** referenced in the Dev Notes source tree: The file `src/app/api/deps.py` (Dependencies/DB session) is shown in the source tree but not created. This is acceptable since the story notes say DB connection will be set up in Story 1.3.

4. **`conftest.py` unused import**: `pytest` is imported but not needed since the fixture uses only `TestClient` and `create_app`. Minor — no functional impact.

### Refactoring Performed

No refactoring performed — findings are all advisory/future improvements.

### Compliance Check

- Coding Standards: ✓ PEP 8 followed, type hints throughout, Pydantic for all API I/O
- Project Structure: ✓ Matches Dev Notes source tree (minus `deps.py` which is deferred)
- Testing Strategy: ✓ All 3 required test scenarios implemented, 89% coverage
- All ACs Met: ✓ All 7 acceptance criteria satisfied

**AC Traceability:**
- AC1 (FastAPI in `apps/api/`): ✓ — Complete application structure
- AC2 (`/health` returns `{"status": "healthy"}`): ✓ — Returns 200 with status + timestamp
- AC3 (`/ready` checks DB): ✓ — Returns 503 when DB unreachable, 200 when reachable
- AC4 (Project structure with `pyproject.toml`): ✓ — Proper setuptools config
- AC5 (Runs on port 8000): ✓ — README documents `--port 8000`
- AC6 (Unit tests with pytest): ✓ — 3 tests, all passing
- AC7 (README documents local run): ✓ — Installation, running, testing, endpoints, env vars

### Improvements Checklist

- [x] All acceptance criteria verified with tests
- [x] Application factory pattern correctly implemented
- [x] Pydantic schemas enforce type safety
- [ ] Consider `asyncio.open_connection()` for non-blocking DB check (future story)
- [ ] Tighten CORS `allow_methods`/`allow_headers` when specific routes are known
- [ ] Add `deps.py` with DB session dependency (Story 1.3)
- [ ] Remove unused `pytest` import from `conftest.py`

### Security Review

- **Secrets**: DB password loaded from environment variable, not hardcoded ✓
- **CORS**: Permissive wildcards — acceptable for development, flag for production hardening
- No injection vectors — health endpoints are read-only with no user input

### Performance Considerations

- Socket-based readiness check has a 2-second timeout — acceptable for K8s probes (default timeout is 1s, but configurable)
- Synchronous socket in async context is a minor concern for high-concurrency scenarios but negligible for health endpoints

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/1.2-python-api-service-health-endpoint.yml

### Recommended Status

✓ Ready for Done
