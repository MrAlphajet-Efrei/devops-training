# Story 2.1: Azure Account & CLI Setup

## Status

**Approved**

---

## Story

**As a** DevOps engineer,
**I want** an Azure account configured with CLI access and service principal,
**so that** I can provision and manage cloud resources programmatically.

---

## Acceptance Criteria

1. Azure account is created with $200 free credits activated
2. Azure CLI is installed and authenticated (`az login`)
3. Service Principal is created for Terraform/GitHub Actions (`az ad sp create-for-rbac`)
4. Service Principal credentials are securely documented (not in repo)
5. Resource Group is created for the project (e.g., `rg-devops-demo`)
6. Subscription ID, Tenant ID, Client ID, and Client Secret are noted
7. `az account show` confirms correct subscription is active

---

## Tasks / Subtasks

- [ ] **Task 1: Create Azure Account** (AC: 1)
  - [ ] Sign up at https://azure.microsoft.com/free/
  - [ ] Activate $200 free credits
  - [ ] Verify account is active and free tier is enabled

- [ ] **Task 2: Install and Configure Azure CLI** (AC: 2, 7)
  - [ ] Install Azure CLI (Windows: `winget install -e --id Microsoft.AzureCLI` or MSI installer)
  - [ ] Run `az login` to authenticate via browser
  - [ ] Run `az account show` to confirm correct subscription is active
  - [ ] Run `az account list -o table` to verify available subscriptions
  - [ ] Set default subscription if multiple exist: `az account set --subscription <subscription-id>`

- [ ] **Task 3: Create Service Principal** (AC: 3, 6)
  - [ ] Create Service Principal with Contributor role:
    ```
    az ad sp create-for-rbac --name "sp-devops-demo" --role Contributor --scopes /subscriptions/<subscription-id>
    ```
  - [ ] Record output values: `appId` (Client ID), `password` (Client Secret), `tenant` (Tenant ID)
  - [ ] Record Subscription ID from `az account show --query id -o tsv`
  - [ ] Verify SP works: `az login --service-principal -u <appId> -p <password> --tenant <tenant>`

- [ ] **Task 4: Securely Document Credentials** (AC: 4, 6)
  - [ ] Create a local-only credentials document (NOT in repo)
  - [ ] Record: Subscription ID, Tenant ID, Client ID, Client Secret
  - [ ] Verify `.gitignore` excludes credential files (e.g., `*.credentials`, `.azure/`)
  - [ ] These values will be needed for GitHub Secrets (Story 2.7) and Terraform (Story 2.2)

- [ ] **Task 5: Create Resource Group** (AC: 5)
  - [ ] Create resource group: `az group create --name rg-devops-demo --location eastus`
  - [ ] Verify: `az group show --name rg-devops-demo -o table`
  - [ ] Note: Location should be consistent across all Azure resources in this project

- [ ] **Task 6: Document Setup** (AC: 1-7)
  - [ ] Create or update `docs/setup-guide.md` with Azure setup instructions
  - [ ] Document prerequisites (Azure account, CLI installation)
  - [ ] Document Service Principal creation steps
  - [ ] Document environment variables needed for later stories (ARM_CLIENT_ID, etc.)

---

## Dev Notes

### Azure Environment Variables

The following environment variables will be used throughout Epic 2 for Terraform and GitHub Actions:
[Source: architecture/13-development-workflow.md#13.4]

| Variable | Description | Source |
|----------|-------------|--------|
| `ARM_CLIENT_ID` | Service Principal App ID | `az ad sp create-for-rbac` output `appId` |
| `ARM_CLIENT_SECRET` | Service Principal Password | `az ad sp create-for-rbac` output `password` |
| `ARM_SUBSCRIPTION_ID` | Azure Subscription ID | `az account show --query id` |
| `ARM_TENANT_ID` | Azure AD Tenant ID | `az ad sp create-for-rbac` output `tenant` |

### Tech Stack Versions

[Source: architecture/3-tech-stack.md]

| Tool | Version | Purpose |
|------|---------|---------|
| Terraform | 1.5+ | Infrastructure provisioning (uses these credentials) |
| GitHub Actions | - | CI/CD (uses these credentials as secrets) |

### Security Requirements

[Source: architecture/15-security-and-performance.md#15.1]

- **Secrets must never be in code/config** — Service Principal credentials must not be committed to the repository
- K8s Secrets (Phase 1) → Azure Key Vault (Phase 2) — this story sets up the Azure foundation for Phase 2

### File Locations

[Source: architecture/12-unified-project-structure.md]

| File | Purpose |
|------|---------|
| `docs/setup-guide.md` | Azure setup documentation |
| `.gitignore` | Must exclude credential files |

### Naming Conventions

Per project conventions, Azure resources should follow a consistent naming pattern:
- Resource Group: `rg-devops-demo`
- Service Principal: `sp-devops-demo`
- Location: `eastus` (or user's preferred region — keep consistent)

### Key Constraints

- **This is a manual/interactive story** — no code to write, but documentation is required
- Service Principal credentials are needed by Stories 2.2 (Terraform), 2.7 (GitHub Actions ACR push), 2.8 (K8s deploy), 2.9 (Terraform pipeline)
- **Free tier limits**: $200 credits, be aware of resource costs
- **Windows environment**: User is on Windows — Azure CLI installs via winget or MSI

### Dependencies on Previous Stories

- **Epic 1 complete**: Local development stack is ready
- No specific code dependencies — this is a setup story

---

## Testing

### Testing Requirements

| Test Type | Coverage | Method |
|-----------|----------|--------|
| Manual | Azure account active | `az account show` |
| Manual | SP authentication | `az login --service-principal` |
| Manual | Resource Group exists | `az group show` |

[Source: architecture/16-testing-strategy.md — E2E: curl smoke tests; this story is manual verification]

### Test Scenarios

1. **Azure CLI authenticated** — `az account show` returns valid subscription
2. **Service Principal works** — `az login --service-principal` succeeds
3. **Resource Group exists** — `az group show --name rg-devops-demo` returns the resource
4. **Credentials documented** — Local credential document exists (not in repo)
5. **No credentials in repo** — `git status` shows no credential files staged

### Test Commands

```bash
# Verify Azure CLI
az account show -o table

# Verify Service Principal
az login --service-principal -u <CLIENT_ID> -p <CLIENT_SECRET> --tenant <TENANT_ID>
az account show

# Verify Resource Group
az group show --name rg-devops-demo -o table

# Verify no secrets in repo
git status
git diff --cached  # Should show no credential files
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Initial story draft | SM Bob |

---

## Dev Agent Record

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
