# Story 1.7: Kind Cluster Setup

## Status

**Done**

---

## Story

**As a** DevOps engineer,
**I want** a local Kubernetes cluster using Kind,
**so that** I can deploy and test Kubernetes manifests locally.

---

## Acceptance Criteria

1. Kind cluster configuration file exists in `infra/kind/`
2. Cluster is created with `kind create cluster` command
3. `kubectl` context is configured to use the Kind cluster
4. Cluster has at least 1 control plane and 1 worker node (or single node for simplicity)
5. Cluster configuration enables Ingress support (extra port mappings)
6. Documentation explains how to create/delete the cluster
7. Script or Makefile target automates cluster creation

---

## Tasks / Subtasks

- [ ] **Task 1: Create Kind Cluster Configuration** (AC: 1, 4, 5)
  - [ ] Create `infra/kind/` directory
  - [ ] Create `infra/kind/cluster-config.yaml` with Kind cluster spec
  - [ ] Configure 1 control-plane node (single-node is acceptable per AC4)
  - [ ] Add `kubeadmConfigPatches` to configure Ingress-ready settings
  - [ ] Add `extraPortMappings` on control-plane node:
    - containerPort 80 → hostPort 80 (HTTP)
    - containerPort 443 → hostPort 443 (HTTPS)
  - [ ] Add node labels for Ingress controller: `ingress-ready: "true"`

- [ ] **Task 2: Create Cluster Management Script** (AC: 2, 3, 7)
  - [ ] Create `scripts/create-kind-cluster.sh`
  - [ ] Add shebang and `set -euo pipefail` for safety
  - [ ] Define cluster name variable (e.g., `devops-demo`)
  - [ ] Check if Kind is installed, print helpful message if not
  - [ ] Check if cluster already exists, skip creation if so
  - [ ] Create cluster using `kind create cluster --name <name> --config infra/kind/cluster-config.yaml`
  - [ ] Verify `kubectl` context is set to the new cluster
  - [ ] Print success message with useful next-step commands
  - [ ] Add a `--delete` flag option that runs `kind delete cluster --name <name>`

- [ ] **Task 3: Add Makefile Targets** (AC: 7)
  - [ ] Create `Makefile` in project root (or extend if it already exists)
  - [ ] Add `kind-create` target that runs `scripts/create-kind-cluster.sh`
  - [ ] Add `kind-delete` target that deletes the Kind cluster
  - [ ] Add `kind-status` target that shows cluster info
  - [ ] Add `.PHONY` declarations for all targets

- [ ] **Task 4: Install NGINX Ingress Controller** (AC: 5)
  - [ ] Add NGINX Ingress installation step to `scripts/create-kind-cluster.sh` (after cluster creation)
  - [ ] Use the Kind-specific NGINX Ingress manifest: `kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml`
  - [ ] Wait for Ingress controller to be ready: `kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=90s`
  - [ ] Add Makefile target `kind-ingress` if user wants to install separately

- [ ] **Task 5: Create Documentation** (AC: 6)
  - [ ] Create or update `infra/kind/README.md`
  - [ ] Document prerequisites (Kind, kubectl, Docker)
  - [ ] Document how to create cluster (`make kind-create` or script)
  - [ ] Document how to delete cluster (`make kind-delete` or script)
  - [ ] Document how to verify cluster is running (`kubectl cluster-info`, `kubectl get nodes`)
  - [ ] Document how to load local Docker images into Kind (`kind load docker-image`)
  - [ ] Document how to access services via port-forward
  - [ ] Document NGINX Ingress setup and verification

- [ ] **Task 6: Verify Cluster Setup** (AC: 2, 3, 4, 5)
  - [ ] Run `scripts/create-kind-cluster.sh` and verify cluster creation
  - [ ] Verify `kubectl get nodes` shows node(s) in Ready state
  - [ ] Verify `kubectl config current-context` points to the Kind cluster
  - [ ] Verify Ingress controller pods are running: `kubectl get pods -n ingress-nginx`
  - [ ] Verify port mappings: `docker port <kind-container> 80` and `443`
  - [ ] Run `kind delete cluster --name devops-demo` and verify clean removal

---

## Dev Notes

### Kind Cluster Configuration Reference

The Kind cluster config uses a YAML spec. For Ingress support, the control-plane node needs extra port mappings and a label.
[Source: architecture/3-tech-stack.md — Kubernetes (Kind/AKS) 1.28+, NGINX Ingress 4.x]

```yaml
# infra/kind/cluster-config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
    extraPortMappings:
      - containerPort: 80
        hostPort: 80
        protocol: TCP
      - containerPort: 443
        hostPort: 443
        protocol: TCP
```

### NGINX Ingress for Kind

Kind requires a specific NGINX Ingress deployment manifest (different from generic Helm installs). The Kind project provides a dedicated manifest at:

```
https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
```

[Source: architecture/3-tech-stack.md — NGINX Ingress 4.x]

After applying, wait for readiness:

```bash
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=90s
```

### Deployment Environment Context

The Kind cluster will serve as the local Kubernetes environment:
[Source: architecture/14-deployment-architecture.md#14.2]

| Environment | Frontend URL | API URL     | Purpose   |
| ----------- | ------------ | ----------- | --------- |
| Kind        | `app.local`  | `api.local` | Local K8s |

These hostnames will be configured via Ingress resources in Story 1.8.

### File Locations

Per the unified project structure:
[Source: architecture/12-unified-project-structure.md]

| File                             | Purpose                                 |
| -------------------------------- | --------------------------------------- |
| `infra/kind/cluster-config.yaml` | Kind cluster configuration              |
| `scripts/create-kind-cluster.sh` | Cluster creation automation             |
| `Makefile`                       | Build/automation targets (project root) |
| `infra/kind/README.md`           | Kind cluster documentation              |

### Previous Story Insights

From Story 1.5 (Docker Containerization):

- Docker images are tagged as `devops-api:0.1.0` and `devops-frontend:0.1.0`
- Images must be loaded into Kind using `kind load docker-image <image>:<tag> --name <cluster>`
- Kind cannot pull from local Docker daemon directly — explicit load is required

From Story 1.6 (Docker Compose):

- PostgreSQL uses `postgres:15-alpine` image
- DB credentials: `app_user` / `changeme` / `devops_demo`
- API runs on port 8000, Frontend on port 3000, PostgreSQL on 5432

### Tech Stack Versions

| Tool          | Version                | Purpose                 |
| ------------- | ---------------------- | ----------------------- |
| Kind          | Latest stable          | Local K8s cluster       |
| Kubernetes    | 1.28+                  | Container orchestration |
| kubectl       | Matching K8s version   | Cluster management      |
| NGINX Ingress | Kind-specific manifest | Traffic routing         |

[Source: architecture/3-tech-stack.md]

### Script Best Practices

- Use `set -euo pipefail` for bash safety
- Check prerequisites before executing (kind, kubectl, docker)
- Make scripts idempotent (skip if cluster exists)
- Provide clear error messages and help text
  [Source: architecture/17-coding-standards.md — Error Handling]

### Key Constraints

- **Single-node cluster is acceptable** (AC4 allows it for simplicity)
- **Ingress port mappings are required** — without them, NGINX Ingress cannot route traffic from host to cluster
- **Kind cluster name should be consistent** — use `devops-demo` to match project naming
- **Scripts must be executable** — remember `chmod +x`
- **Windows compatibility**: The user is on Windows. Scripts should work with Git Bash or WSL. Consider adding a note about this in documentation.

### Dependencies on Previous Stories

- **Story 1.5**: Docker images must be buildable (Dockerfiles exist)
- **Story 1.6**: Docker Compose stack provides context for service configuration

---

## Testing

### Testing Requirements

| Test Type | Coverage          | Method                                  |
| --------- | ----------------- | --------------------------------------- |
| E2E       | Cluster creation  | Script execution + kubectl verification |
| E2E       | Ingress readiness | kubectl wait + pod status check         |
| E2E       | Clean deletion    | kind delete + verification              |

[Source: architecture/16-testing-strategy.md — E2E: curl smoke tests]

### Test Scenarios

1. **Cluster creates successfully** — `scripts/create-kind-cluster.sh` exits 0
2. **Node is Ready** — `kubectl get nodes` shows Ready status
3. **Correct context** — `kubectl config current-context` returns `kind-devops-demo`
4. **Ingress controller running** — `kubectl get pods -n ingress-nginx` shows Running/Ready
5. **Port mappings work** — Host ports 80 and 443 are mapped to the Kind container
6. **Idempotent creation** — Running the script twice doesn't error
7. **Clean deletion** — `kind delete cluster --name devops-demo` removes everything
8. **Makefile targets work** — `make kind-create`, `make kind-delete`, `make kind-status` all function

### Test Commands

```bash
# Create cluster
make kind-create
# OR: bash scripts/create-kind-cluster.sh

# Verify node
kubectl get nodes

# Verify context
kubectl config current-context

# Verify Ingress
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx

# Test idempotency
make kind-create  # Should skip or succeed gracefully

# Clean up
make kind-delete
```

---

## Change Log

| Date       | Version | Description         | Author |
| ---------- | ------- | ------------------- | ------ |
| 2026-01-27 | 1.0     | Initial story draft | SM Bob |

---

## Dev Agent Record

_To be filled by Dev Agent_

---

## QA Results

### Review Date: 2026-02-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Kind cluster setup is well-implemented with comprehensive script, proper configuration, and detailed documentation. All 7 acceptance criteria are met. Script follows best practices with error handling and idempotency.

### Requirements Traceability

| AC | Requirement | Implementation | Coverage |
|----|-------------|----------------|----------|
| 1 | Kind config file in infra/kind/ | `infra/kind/cluster-config.yaml` | ✅ Complete |
| 2 | Cluster created with kind create cluster | `scripts/create-kind-cluster.sh` line 37 | ✅ Complete |
| 3 | kubectl context configured | Script verifies context (lines 38-42) | ✅ Complete |
| 4 | At least 1 control plane node | Single control-plane configured | ✅ Complete |
| 5 | Ingress support enabled | extraPortMappings + NGINX install | ✅ Complete |
| 6 | Documentation explains create/delete | `infra/kind/README.md` (comprehensive) | ✅ Complete |
| 7 | Script/Makefile automates creation | Both script and Makefile targets | ✅ Complete |

### Refactoring Performed

None required - implementation is clean and well-structured.

### Compliance Check

- Coding Standards: ✅ Bash script with `set -euo pipefail`, functions, clear structure
- Project Structure: ✅ Files in expected locations per architecture docs
- Testing Strategy: ✅ Manual verification via kubectl commands
- All ACs Met: ✅ 7/7 acceptance criteria satisfied

### Improvements Checklist

- [x] Script uses `set -euo pipefail` for safety
- [x] Prerequisites check (kind, kubectl, docker)
- [x] Idempotent - skips if cluster exists
- [x] NGINX Ingress auto-installed with wait
- [x] --delete flag for cleanup
- [x] --help flag for usage
- [x] Comprehensive README documentation
- [x] Windows compatibility documented
- [ ] **Note**: Story tasks still show `[ ]` but implementation is complete

### Security Review

| Aspect | Status | Notes |
|--------|--------|-------|
| Script safety | ✅ | Uses `set -euo pipefail` |
| Prerequisites validation | ✅ | Checks for required tools before executing |
| Cluster isolation | ✅ | Kind clusters are isolated Docker containers |

### Performance Considerations

- NGINX Ingress wait timeout of 120s is appropriate
- Single-node cluster is efficient for local development

### Test Architecture Assessment

- **Test Type**: E2E via script execution + kubectl verification
- **Coverage**: Cluster creation, Ingress readiness, deletion
- **Documented**: Test commands in story and README

### Script Quality Highlights

```bash
# Excellent patterns observed:
- set -euo pipefail (fail-fast)
- Idempotent creation (checks if cluster exists)
- Clear usage() function
- Proper error messages
- Wait for Ingress readiness
```

### Files Modified During Review

None - no refactoring required.

### Gate Status

**Gate: PASS** → `docs/qa/gates/1.7-kind-cluster.yml`

### Recommended Status

✅ **Ready for Done** - All acceptance criteria met. Status already "Done" which is appropriate.

**Note to Story Owner**: Consider updating the Tasks/Subtasks checkboxes from `[ ]` to `[x]` to reflect completed work.
