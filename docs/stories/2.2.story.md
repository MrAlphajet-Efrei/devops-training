# Story 2.2: Terraform Remote State Backend

## Status

**Approved**

---

## Story

**As a** DevOps engineer,
**I want** Terraform state stored remotely in Azure Storage,
**so that** state is secure, shared, and supports locking.

---

## Acceptance Criteria

1. Azure Storage Account is created (manually or via bootstrap script)
2. Blob container `tfstate` exists for state files
3. Terraform backend configuration uses `azurerm` provider
4. `backend.tf` configures remote state with storage account details
5. State locking is enabled via Azure Blob lease mechanism
6. `terraform init` successfully initializes with remote backend
7. Bootstrap script or documentation explains initial setup
8. `.gitignore` excludes local `.terraform/` and state files

---

## Tasks / Subtasks

- [ ] **Task 1: Create Bootstrap Script for Azure Storage** (AC: 1, 2, 7)
  - [ ] Create `scripts/bootstrap-terraform.sh`
  - [ ] Add shebang and `set -euo pipefail`
  - [ ] Define variables: resource group name, storage account name, container name, location
  - [ ] Storage account name must be globally unique, lowercase, 3-24 chars, alphanumeric only (e.g., `stdevopsdemo<unique>`)
  - [ ] Create storage account: `az storage account create --name <name> --resource-group rg-devops-demo --sku Standard_LRS --encryption-services blob`
  - [ ] Get storage account key: `az storage account keys list --resource-group rg-devops-demo --account-name <name> --query '[0].value' -o tsv`
  - [ ] Create blob container: `az storage container create --name tfstate --account-name <name> --account-key <key>`
  - [ ] Print success message with storage account details needed for backend.tf
  - [ ] Make script idempotent (check if resources exist before creating)

- [ ] **Task 2: Create Terraform Directory Structure** (AC: 3, 4)
  - [ ] Create `infra/terraform/` directory
  - [ ] Create `infra/terraform/backend.tf` with azurerm backend configuration
  - [ ] Create `infra/terraform/providers.tf` with azurerm provider configuration
  - [ ] Create `infra/terraform/variables.tf` with common variables (resource_group_name, location)
  - [ ] Create `infra/terraform/outputs.tf` (empty for now)
  - [ ] Create `infra/terraform/main.tf` (empty for now — modules added in later stories)

- [ ] **Task 3: Configure Backend** (AC: 3, 4, 5)
  - [ ] In `backend.tf`, configure:
    ```hcl
    terraform {
      backend "azurerm" {
        resource_group_name  = "rg-devops-demo"
        storage_account_name = "<storage-account-name>"
        container_name       = "tfstate"
        key                  = "devops-demo.tfstate"
      }
    }
    ```
  - [ ] State locking is automatic with azurerm backend (uses Azure Blob lease)
  - [ ] In `providers.tf`, configure:
    ```hcl
    terraform {
      required_version = ">= 1.5.0"
      required_providers {
        azurerm = {
          source  = "hashicorp/azurerm"
          version = "~> 3.0"
        }
      }
    }
    provider "azurerm" {
      features {}
    }
    ```

- [ ] **Task 4: Configure .gitignore** (AC: 8)
  - [ ] Ensure `.gitignore` includes:
    ```
    # Terraform
    .terraform/
    *.tfstate
    *.tfstate.backup
    *.tfvars
    !*.tfvars.example
    .terraform.lock.hcl
    ```
  - [ ] Note: `.terraform.lock.hcl` can optionally be committed — decide and document

- [ ] **Task 5: Initialize and Verify** (AC: 6)
  - [ ] Run bootstrap script to create Azure Storage
  - [ ] Set ARM environment variables (from Story 2.1)
  - [ ] Run `terraform init` from `infra/terraform/`
  - [ ] Verify backend initialization message confirms azurerm backend
  - [ ] Run `terraform plan` (should show no changes — empty config)

- [ ] **Task 6: Add Makefile Targets** (AC: 6, 7)
  - [ ] Add `tf-init` target: `cd infra/terraform && terraform init`
  - [ ] Add `tf-plan` target: `cd infra/terraform && terraform plan`
  - [ ] Add `tf-apply` target: `cd infra/terraform && terraform apply`
  - [ ] Add `tf-bootstrap` target: `bash scripts/bootstrap-terraform.sh`

- [ ] **Task 7: Document Setup** (AC: 7)
  - [ ] Create `infra/terraform/README.md`
  - [ ] Document prerequisites (Azure CLI, Service Principal from Story 2.1)
  - [ ] Document bootstrap process (storage account creation)
  - [ ] Document how to set ARM environment variables
  - [ ] Document terraform init/plan/apply workflow
  - [ ] Document state locking behavior

---

## Dev Notes

### Terraform Directory Structure

[Source: architecture/12-unified-project-structure.md]

```
infra/terraform/
├── environments/
│   ├── dev/
│   └── prod/
├── modules/
│   ├── acr/
│   ├── keyvault/
│   ├── storage/
│   └── aks/
├── backend.tf
├── providers.tf
├── variables.tf
├── outputs.tf
├── main.tf
└── README.md
```

Note: The `modules/` and `environments/` directories will be created in later stories (2.3, 2.4, 2.5). This story focuses on the root-level configuration.

### Tech Stack Versions

[Source: architecture/3-tech-stack.md]

| Tool | Version | Purpose |
|------|---------|---------|
| Terraform | 1.5+ | Infrastructure provisioning |
| azurerm provider | ~> 3.0 | Azure resource management |

### Azure Backend State Locking

The azurerm backend automatically provides state locking via Azure Blob lease mechanism. No additional configuration is needed — Terraform acquires a lease on the state blob during operations and releases it when done. If a lock is stuck, it can be force-unlocked with `terraform force-unlock <lock-id>`.

### Environment Variables for Terraform

[Source: architecture/13-development-workflow.md#13.4]

Terraform authenticates to Azure using these environment variables:

```bash
export ARM_CLIENT_ID="<from-story-2.1>"
export ARM_CLIENT_SECRET="<from-story-2.1>"
export ARM_SUBSCRIPTION_ID="<from-story-2.1>"
export ARM_TENANT_ID="<from-story-2.1>"
```

### Naming Conventions

- Storage account names: lowercase, alphanumeric, 3-24 chars, globally unique
- Resource naming pattern: `st` prefix for storage (e.g., `stdevopsdemo001`)
- Blob container: `tfstate`
- State key: `devops-demo.tfstate`

### Common Makefile Targets

[Source: architecture/13-development-workflow.md#13.3]

```bash
make tf-init    # Initialize Terraform
make tf-plan    # Plan changes
make tf-apply   # Apply changes
```

### Key Constraints

- **Bootstrap is a one-time manual step** — the storage account that holds state cannot itself be managed by Terraform (chicken-and-egg problem)
- **Storage account name must be globally unique** — include a random suffix or project-specific identifier
- **State locking is critical** — prevents concurrent modifications that could corrupt state
- **Windows environment**: Scripts should work with Git Bash or WSL
- `.terraform.lock.hcl` — committing it ensures consistent provider versions across team members. Recommended to commit.

### Dependencies on Previous Stories

- **Story 2.1**: Azure account, CLI, Service Principal, and Resource Group must exist

---

## Testing

### Testing Requirements

| Test Type | Coverage | Method |
|-----------|----------|--------|
| E2E | Bootstrap script | Script execution + az verification |
| E2E | Terraform init | `terraform init` success |
| E2E | State locking | Verify blob lease during plan |

[Source: architecture/16-testing-strategy.md — E2E: curl smoke tests]

### Test Scenarios

1. **Bootstrap creates storage** — Script runs without errors, storage account exists
2. **Blob container exists** — `az storage container list` shows `tfstate`
3. **Terraform init succeeds** — `terraform init` completes with azurerm backend
4. **Terraform plan works** — `terraform plan` runs (no changes expected)
5. **State file exists in Azure** — After first plan/apply, blob exists in container
6. **Gitignore works** — `.terraform/` and `*.tfstate` are not tracked
7. **Idempotent bootstrap** — Running script twice doesn't error

### Test Commands

```bash
# Run bootstrap
make tf-bootstrap

# Verify storage account
az storage account show --name <storage-account-name> --resource-group rg-devops-demo -o table

# Verify blob container
az storage container list --account-name <storage-account-name> --query '[].name' -o tsv

# Initialize Terraform
cd infra/terraform
export ARM_CLIENT_ID="..."
export ARM_CLIENT_SECRET="..."
export ARM_SUBSCRIPTION_ID="..."
export ARM_TENANT_ID="..."
terraform init

# Verify plan
terraform plan

# Verify gitignore
git status  # Should not show .terraform/ or *.tfstate files
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Initial story draft | SM Bob |

---

## Dev Agent Record

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
