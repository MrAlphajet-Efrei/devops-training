# Story 2.3: Terraform Azure Resources - ACR

## Status

**Approved**

---

## Story

**As a** DevOps engineer,
**I want** Azure Container Registry provisioned via Terraform,
**so that** I have a secure place to store container images.

---

## Acceptance Criteria

1. ACR resource is defined in Terraform (`azurerm_container_registry`)
2. ACR uses Basic SKU (free tier eligible)
3. Admin user is enabled for simple authentication (or use Service Principal)
4. ACR name is globally unique and follows naming convention
5. `terraform plan` shows expected resources
6. `terraform apply` successfully creates ACR
7. `docker login` to ACR succeeds using credentials
8. Output values expose ACR login server URL and credentials

---

## Tasks / Subtasks

- [ ] **Task 1: Create ACR Terraform Configuration** (AC: 1, 2, 3, 4)
  - [ ] Create `infra/terraform/acr.tf` (inline first — will be modularized in Story 2.5)
  - [ ] Define `azurerm_container_registry` resource:
    - Name: globally unique, alphanumeric only (e.g., `acrdevopsdemo<unique>`)
    - Resource group: `rg-devops-demo` (from data source or variable)
    - Location: same as resource group
    - SKU: `Basic`
    - Admin enabled: `true` (simple auth for learning)
  - [ ] Add variables in `variables.tf`:
    - `acr_name` with description and validation (alphanumeric, 5-50 chars)
    - `location` (default: `eastus`)
    - `resource_group_name` (default: `rg-devops-demo`)

- [ ] **Task 2: Reference Existing Resource Group** (AC: 1)
  - [ ] Add `data "azurerm_resource_group"` block to reference the existing `rg-devops-demo`
  - [ ] OR use variable for resource group name — both approaches are valid
  - [ ] Ensure the resource group from Story 2.1 is referenced, not recreated

- [ ] **Task 3: Define Outputs** (AC: 8)
  - [ ] Add to `outputs.tf`:
    - `acr_login_server` — the ACR login server URL (e.g., `acrdevopsdemo.azurecr.io`)
    - `acr_admin_username` — admin username
    - `acr_admin_password` — admin password (mark as sensitive)
  - [ ] Mark sensitive outputs with `sensitive = true`

- [ ] **Task 4: Plan and Apply** (AC: 5, 6)
  - [ ] Set ARM environment variables
  - [ ] Run `terraform plan` — verify it shows 1 resource to create (ACR)
  - [ ] Review plan output for correctness
  - [ ] Run `terraform apply` — confirm resource creation
  - [ ] Verify ACR exists: `az acr show --name <acr-name> -o table`

- [ ] **Task 5: Verify Docker Login** (AC: 7)
  - [ ] Get ACR credentials: `terraform output acr_login_server`
  - [ ] Login to ACR: `az acr login --name <acr-name>`
  - [ ] OR: `docker login <acr-login-server> -u <admin-username> -p <admin-password>`
  - [ ] Verify login succeeds

- [ ] **Task 6: Add Makefile Targets** (AC: 5, 6)
  - [ ] Update existing `tf-plan` and `tf-apply` targets if not already generic
  - [ ] Add `acr-login` target: `az acr login --name <acr-name>`

- [ ] **Task 7: Document** (AC: 1-8)
  - [ ] Update `infra/terraform/README.md` with ACR section
  - [ ] Document ACR naming constraints
  - [ ] Document how to login to ACR
  - [ ] Document outputs available

---

## Dev Notes

### Terraform ACR Resource Reference

```hcl
resource "azurerm_container_registry" "acr" {
  name                = var.acr_name
  resource_group_name = var.resource_group_name
  location            = var.location
  sku                 = "Basic"
  admin_enabled       = true
}
```

### ACR Naming Rules

- Must be globally unique across all of Azure
- 5-50 characters, alphanumeric only (no hyphens or underscores)
- Naming convention: `acr` prefix + project name + optional unique suffix (e.g., `acrdevopsdemo001`)
[Source: architecture/12-unified-project-structure.md — infra/terraform/ structure]

### Output Values Pattern

```hcl
output "acr_login_server" {
  value = azurerm_container_registry.acr.login_server
}

output "acr_admin_username" {
  value = azurerm_container_registry.acr.admin_username
}

output "acr_admin_password" {
  value     = azurerm_container_registry.acr.admin_password
  sensitive = true
}
```

### CI/CD Pipeline Context

[Source: architecture/14-deployment-architecture.md#14.3]

The ACR will be used in the CI/CD pipeline (Story 2.7):
- **On merge to main**: Build Docker images → Push to ACR with SHA tag
- Images are tagged with git SHA and `latest`

### Docker Image Tags

From Story 1.5:
- API image: `devops-api:0.1.0`
- Frontend image: `devops-frontend:0.1.0`

In ACR, these will become:
- `<acr-login-server>/devops-api:<git-sha>`
- `<acr-login-server>/devops-frontend:<git-sha>`

### Tech Stack Versions

[Source: architecture/3-tech-stack.md]

| Tool | Version | Purpose |
|------|---------|---------|
| Terraform | 1.5+ | Infrastructure provisioning |
| Docker | 24.x | Container builds (will push to ACR) |

### Key Constraints

- **Basic SKU** — sufficient for learning, supports admin auth, limited to 10 GiB storage
- **Admin auth is simple but not production-grade** — acceptable for this project scope
- **ACR name cannot be changed** after creation (immutable)
- **This is inline Terraform** — will be refactored into a module in Story 2.5
- **Cost awareness**: Basic SKU is ~$0.167/day (~$5/month)

### Dependencies on Previous Stories

- **Story 2.1**: Azure account, Service Principal, Resource Group
- **Story 2.2**: Terraform backend configured and initialized

---

## Testing

### Testing Requirements

| Test Type | Coverage | Method |
|-----------|----------|--------|
| E2E | Terraform plan/apply | CLI execution |
| E2E | ACR creation | az acr show |
| E2E | Docker login | docker login to ACR |

[Source: architecture/16-testing-strategy.md — E2E: curl smoke tests]

### Test Scenarios

1. **Terraform plan shows ACR** — `terraform plan` shows 1 resource to add
2. **Terraform apply succeeds** — ACR is created without errors
3. **ACR exists in Azure** — `az acr show --name <name>` returns resource details
4. **ACR login works** — `az acr login --name <name>` succeeds
5. **Outputs are correct** — `terraform output acr_login_server` returns valid URL
6. **Docker login works** — `docker login <login-server>` succeeds with admin credentials

### Test Commands

```bash
cd infra/terraform

# Plan
terraform plan

# Apply
terraform apply

# Verify ACR
az acr show --name <acr-name> -o table

# Login
az acr login --name <acr-name>

# Verify outputs
terraform output acr_login_server
terraform output acr_admin_username
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Initial story draft | SM Bob |

---

## Dev Agent Record

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
