# Story 1.5: Docker Containerization

## Status

**Draft**

---

## Story

**As a** DevOps engineer,
**I want** optimized Dockerfiles for each service,
**so that** the application can run consistently across environments.

---

## Acceptance Criteria

1. Multi-stage Dockerfile for API minimizes image size (builder + runtime stages)
2. Multi-stage Dockerfile for Frontend (build + nginx/node serve)
3. Both images run as non-root user (UID 1000)
4. Images are tagged with version (e.g., `api:0.1.0`)
5. `.dockerignore` files exclude unnecessary files from build context
6. Images build successfully with `docker build` command
7. Image sizes are reasonable (API < 200MB, Frontend < 100MB)

---

## Tasks / Subtasks

- [ ] **Task 1: Create API Dockerfile** (AC: 1, 3, 6, 7)
  - [ ] Create `apps/api/Dockerfile`
  - [ ] Stage 1 (builder): Install dependencies with Poetry/pip
  - [ ] Stage 2 (runtime): Copy only necessary files
  - [ ] Use `python:3.11-slim` as base image
  - [ ] Create non-root user with UID 1000
  - [ ] Set WORKDIR to `/app`
  - [ ] Expose port 8000
  - [ ] Set CMD to run uvicorn

- [ ] **Task 2: Create Frontend Dockerfile** (AC: 2, 3, 6, 7)
  - [ ] Create `apps/frontend/Dockerfile`
  - [ ] Stage 1 (deps): Install node_modules
  - [ ] Stage 2 (builder): Build Next.js application
  - [ ] Stage 3 (runner): Minimal runtime image
  - [ ] Use `node:18-alpine` as base image
  - [ ] Enable Next.js standalone output mode
  - [ ] Create non-root user with UID 1000
  - [ ] Expose port 3000
  - [ ] Set CMD to run Node.js server

- [ ] **Task 3: Create .dockerignore Files** (AC: 5)
  - [ ] Create `apps/api/.dockerignore`
  - [ ] Exclude: `.git`, `__pycache__`, `.venv`, `.pytest_cache`, `tests/`
  - [ ] Create `apps/frontend/.dockerignore`
  - [ ] Exclude: `.git`, `node_modules`, `.next`, `.env*`

- [ ] **Task 4: Configure Next.js for Standalone** (AC: 2)
  - [ ] Update `next.config.js` with `output: 'standalone'`
  - [ ] Verify standalone build creates proper output

- [ ] **Task 5: Test Image Builds** (AC: 4, 6, 7)
  - [ ] Build API image: `docker build -t api:0.1.0 apps/api/`
  - [ ] Build Frontend image: `docker build -t frontend:0.1.0 apps/frontend/`
  - [ ] Verify API image size < 200MB
  - [ ] Verify Frontend image size < 100MB
  - [ ] Test containers start successfully

- [ ] **Task 6: Document Build Process**
  - [ ] Update API README with Docker instructions
  - [ ] Update Frontend README with Docker instructions
  - [ ] Document image tagging conventions

---

## Dev Notes

### API Dockerfile

```dockerfile
# apps/api/Dockerfile

# Stage 1: Builder
FROM python:3.11-slim as builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy dependency files
COPY pyproject.toml poetry.lock* ./

# Install dependencies
RUN pip install --no-cache-dir poetry \
    && poetry config virtualenvs.create false \
    && poetry install --no-dev --no-interaction --no-ansi

# Stage 2: Runtime
FROM python:3.11-slim as runtime

WORKDIR /app

# Create non-root user
RUN groupadd -g 1000 appgroup \
    && useradd -u 1000 -g appgroup -s /bin/sh appuser

# Copy dependencies from builder
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy application code
COPY --chown=appuser:appgroup src/ ./src/

USER appuser

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Frontend Dockerfile

```dockerfile
# apps/frontend/Dockerfile

# Stage 1: Dependencies
FROM node:18-alpine AS deps
WORKDIR /app
COPY package.json package-lock.json* ./
RUN npm ci --only=production

# Stage 2: Builder
FROM node:18-alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
ENV NEXT_TELEMETRY_DISABLED 1
RUN npm run build

# Stage 3: Runner
FROM node:18-alpine AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

# Create non-root user
RUN addgroup -g 1000 -S nodejs \
    && adduser -S nextjs -u 1000 -G nodejs

# Copy built application
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

### .dockerignore for API

```
# apps/api/.dockerignore
.git
.gitignore
__pycache__
*.pyc
*.pyo
.pytest_cache
.coverage
htmlcov
.venv
venv
.env
.env.*
tests/
*.md
Dockerfile
.dockerignore
```

### .dockerignore for Frontend

```
# apps/frontend/.dockerignore
.git
.gitignore
node_modules
.next
.env*
*.md
Dockerfile
.dockerignore
coverage
.turbo
```

### Next.js Config for Standalone

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
  reactStrictMode: true,
};

module.exports = nextConfig;
```

### Image Size Targets

| Image | Target Size | Base Image |
|-------|-------------|------------|
| API | < 200MB | python:3.11-slim |
| Frontend | < 100MB | node:18-alpine |

### Security Requirements

- Both images run as non-root user (UID 1000)
- No secrets baked into images
- Minimal attack surface (slim/alpine bases)

### Dependencies on Previous Stories

- **Story 1.2**: API application must be complete
- **Story 1.4**: Frontend application must be complete

### Build Commands

```bash
# Build API image
docker build -t devops-api:0.1.0 -f apps/api/Dockerfile apps/api/

# Build Frontend image
docker build -t devops-frontend:0.1.0 -f apps/frontend/Dockerfile apps/frontend/

# Check image sizes
docker images | grep devops
```

---

## Testing

### Test Scenarios

1. **API image builds successfully** - `docker build` completes without errors
2. **Frontend image builds successfully** - `docker build` completes without errors
3. **API container starts** - Container runs and health endpoint responds
4. **Frontend container starts** - Container runs and serves pages
5. **Images run as non-root** - Verify user inside container is not root
6. **Image sizes are acceptable** - API < 200MB, Frontend < 100MB

### Test Commands

```bash
# Test API container
docker run -d --name api-test -p 8000:8000 devops-api:0.1.0
curl http://localhost:8000/health
docker exec api-test whoami  # Should NOT be root
docker stop api-test && docker rm api-test

# Test Frontend container
docker run -d --name frontend-test -p 3000:3000 devops-frontend:0.1.0
curl http://localhost:3000
docker exec frontend-test whoami  # Should NOT be root
docker stop frontend-test && docker rm frontend-test

# Check sizes
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep devops
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-26 | 1.0 | Initial story draft | SM Bob |

---

## Dev Agent Record

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
